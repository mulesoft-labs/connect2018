<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:java="http://www.mulesoft.org/schema/mule/java" xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
	xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
http://www.mulesoft.org/schema/mule/java http://www.mulesoft.org/schema/mule/java/current/mule-java.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="0fb42499-27d6-4b80-820b-111294c44e78" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<http:request-config name="DialogFlowAPI" doc:name="HTTP Request configuration" doc:id="d7d35565-feda-463b-afa0-0363bdea65b7" basePath="/api">
		<http:request-connection protocol="HTTPS" host="api.dialogflow.com" port="443"/>
	</http:request-config>
	<http:request-config name="OrderAPI" doc:name="HTTP Request configuration" doc:id="de89657a-b36a-4350-a852-dd9246798d29" basePath="/mocks/449556cb-6c67-4cc2-bd92-18b335ac4e01">
		<http:request-connection protocol="HTTPS" host="mocksvc.mulesoft.com" port="443"/>
	</http:request-config>
	<http:request-config name="Catalog_API" doc:name="HTTP Request configuration" doc:id="e992ca9d-8c0d-434e-883f-4ae4c9795d05" basePath="/mocks/dfe96a2b-b982-484d-8c72-00cfc8f4fddc" >
		<http:request-connection host="mocksvc.mulesoft.com" port="443" protocol="HTTPS"/>
	</http:request-config>
	<flow name="order-change-fullfilmentFlow" doc:id="c659e6a9-f568-4ac4-a07a-3b06ce163cba" >
		<http:listener doc:name="Listener" doc:id="589b4cfa-39e0-4ba7-9dc9-21cc45a51025" config-ref="HTTP_Listener_config" path="/chat"/>
		<scripting:execute engine="groovy" doc:name="Execute read index.html file from resource classpath" doc:id="40cafedc-8f29-49d8-9c49-5da60829e60f">
			<scripting:code>return Thread.currentThread().getContextClassLoader().getResourceAsStream('index.html').text</scripting:code>
		</scripting:execute>
		<set-payload value="#[payload]" doc:name="Set Payload mimeType to text/html" doc:id="897645ab-d3b7-40bb-8392-76be680e7521" mimeType="text/html"/>
	</flow>
	<flow name="send-UI-request-to-DialogFlow" doc:id="1f3dd482-787c-4da8-83f8-7a2f10b16698" >
		<http:listener doc:name="Listener" doc:id="31da4c63-7064-4eea-ab24-c43e4a3fba5e" config-ref="HTTP_Listener_config" path="/request" outputMimeType="application/json"/>
		<http:request method="POST" doc:name="Request" doc:id="73ea48bb-a89c-4a79-9453-d4f48abaeb27" config-ref="DialogFlowAPI" path="/query" outputMimeType="application/json">
			<http:headers ><![CDATA[#[output applicaton/java
---
{
	"Authorization" : "Bearer 0b165f1b68644f4d857cb8433b1e0286",
	"Content-Type" : "application/json"
}]]]></http:headers>
			<http:query-params ><![CDATA[#[output applicaton/java
---
{
	"v" : "20150910"
}]]]></http:query-params>
		</http:request>
		<logger level="INFO" doc:name="Logger" doc:id="d99ee9f2-ddf4-46a3-bf58-fa8a715721c9" message="#[payload]"/>
	</flow>
	<flow name="order-change-fullfilmentFlow1" doc:id="9b0e0c03-a2fa-49e5-8f13-65cf587ce84a" >
		<http:listener doc:name="Listener" doc:id="9e153406-b378-4dbf-921f-2cc3609dcc40" config-ref="HTTP_Listener_config" path="/"/>
		<logger level="INFO" doc:name="Logger" doc:id="8ef3ec55-0060-4deb-94f1-118f7281249a" message="order-change-fullfilmentFlow"/>
		<ee:transform doc:name="Transform Message" doc:id="dc11db77-2739-4a05-b3dd-3d266e0427fb">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-payload>
					</ee:message>
			<ee:variables >
				<ee:set-variable variableName="action" ><![CDATA[%dw 2.0
output application/java
---
payload.result.action]]></ee:set-variable>
			</ee:variables>
				</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="91688f5c-6910-45a3-bb34-cca01797fb84" message='"Action: " #[vars.action]'/>
		<choice doc:name="Choice" doc:id="e40a9d16-9329-43cc-8367-a4980ec0acd5" >
			<when expression='#[vars.action == "list-orders"]'>
				<flow-ref doc:name="List Orders" doc:id="7313524c-e14c-43cc-921a-4ce6f5878b1d" name="listOrdersFlow"/>
			</when>
			<when expression='#[vars.action == "get-order-details"]' >
				<flow-ref doc:name="showOrderDetails" doc:id="ab09da6f-59f5-4e02-a228-a7efc604ddbe" name="showOrderDetails"/>
			</when>
			<when expression='#[vars.action == "change-item-quantity"]' >
				<flow-ref doc:name="change-item-quantity" doc:id="0fa7c6b9-9981-4ffb-8aaa-c37bf1df8388" name="change-item-quantity"/>
			</when>
			<when expression='#[vars.action == "change-order-quantity-confirmation"]' >
				<flow-ref doc:name="change-order-quantity-confirmation" doc:id="fc9cfcf4-d7a0-4132-a57e-7c936f7822e0" name="change-order-quantity-confirmation"/>
			</when>
			<when expression='#[vars.action == "add-new-product"]' >
				<flow-ref doc:name="add-new-product" doc:id="111045fc-28c1-4243-ad6b-0ba2335920d2" name="add-new-product" />
			</when>
			<when expression='#[vars.action == "add-suggested-product"]' >
				<flow-ref doc:name="add-suggested-product" doc:id="6a89b322-dcc3-4ec5-8c62-fc7094c54ecb" name="add-suggested-product"/>
			</when>
			<otherwise >
				<ee:transform doc:name="Transform Message" doc:id="f69deeb9-6690-484f-afbd-9722bb880573" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
  "speech": "Nope",
  "displayText": "Nope",
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</otherwise>
		</choice>
	</flow>
	<sub-flow name="add-suggested-product" doc:id="8268e97c-f4b4-4d7a-b8a9-826b1339476e" >
		<logger message="" />
	</sub-flow>
	<sub-flow name="add-new-product" doc:id="4b1cc876-0bdc-4b94-aa6c-9d9f53104fa3" >
		<logger message="" />
	</sub-flow>
	<sub-flow name="change-order-quantity-confirmation" doc:id="a39e8416-3103-4681-afa6-88eb7a617ec0" >
		<logger message="" />
	</sub-flow>
	<sub-flow name="change-item-quantity" doc:id="2dd7b9c9-96e0-400a-89cb-ec92f709c7e3" >
		<ee:transform doc:name="Transform Message" doc:id="43467a82-7f84-4955-892a-5b4ce6a5becc" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.result.contexts[0].parameters.new_products map ($)]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="urlWithOrderID" ><![CDATA[%dw 2.0
output application/java
---
"/ordering/orders/" ++ (payload.result.contexts[0].parameters.order_id as String)]]></ee:set-variable>
				<ee:set-variable variableName="orderID" ><![CDATA[%dw 2.0
output application/java
---
payload.result.contexts[0].parameters.order_id as Number]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<java:new doc:name="New products as an ArrayList" doc:id="62458363-cfb7-4008-9fe1-c9d3bf18da8e" class="java.util.ArrayList" constructor="ArrayList()" target="products"/>
		<foreach doc:name="For Each" doc:id="fe25ed68-9801-4df2-a3e4-b95a18fb55ac" collection="#[payload]">
			<ee:transform doc:name="Transform Message" doc:id="b5d95473-2404-4ff2-8e78-d8f4252bdeb4">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
"/catalog/products/" ++ (payload.id as String)]]></ee:set-payload>
			</ee:message>
				<ee:variables >
					<ee:set-variable variableName="productNewAmount" ><![CDATA[%dw 2.0
output application/java
---
payload.newAmount as Number]]></ee:set-variable>
					<ee:set-variable variableName="productCurrentAmount" ><![CDATA[%dw 2.0
output application/java
---
payload.currentAmount as Number]]></ee:set-variable>
				</ee:variables>
		</ee:transform>
			<http:request method="GET" doc:name="Retrieve the productData" doc:id="b5d8485b-3ff7-47f8-bb9c-8ef7306cce73" config-ref="Catalog_API" path="#[payload]"/>
			<ee:transform doc:name="Transform Message" doc:id="04a43577-05d8-41cf-94b7-6ea166f63312" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
"/ordering/orders/" ++ (vars.orderID as String)]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="product" ><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<http:request method="PATCH" doc:name="Updated Order Product quantity" doc:id="6d705c92-eab7-4e57-958a-7198e40a806b" config-ref="OrderAPI" path="#[payload]" />
			<ee:transform doc:name="Transform Message" doc:id="ffcad589-68e3-4281-8f23-95f3db3cea5f" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
  product: vars.product,
  newAmount: vars.productNewAmount,
  currentAmount: vars.productCurrentAmount,
  newOrderTotalAmountPrice: (payload.totalAmountPrice as String) ++ " " ++ (payload.totalAmountPriceCurrency as String)
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<scripting:execute engine="groovy" doc:name="Execute" doc:id="4b7b2de5-a9d4-4ef7-bd32-272b7fb8dfb4" >
				<scripting:code >vars.products.add(payload)</scripting:code>
			</scripting:execute>
		</foreach>
		<ee:transform doc:name="Transform Message" doc:id="57b602d1-4241-4fe9-8b1f-e123839be6c6" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	orderID: vars.orderID,
	products: vars.products
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Transform Message" doc:id="8a1072f0-b5ff-4db5-b570-d2eeebd7134d" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="preLabel" ><![CDATA[%dw 2.0
output application/json
---
(
	payload.products map (
		"[orderID=" ++ (payload.orderID as String)
		++ "][productID=" ++ ($.product.id as String)
		++ "] Qty."
		++ ($.newAmount as String)
		++ " \""
		++ ($.product.copy as String)
		++ "\" ” from "
		++ ($.currentAmount as String) ++ " to "
		++ ($.newAmount as String) ++ ". <BR> Your new order now comes out to "
		++  ($.newOrderTotalAmountPrice as String)
	) map ($ ++ ", ")
) 
reduce ($$ ++ $) as String]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Copy_of_Transform Message" doc:id="2019d878-9ebf-4ce5-a057-01efdd4e7c39">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
var label = vars.preLabel replace /..$/ with ""
---
{
  "speech": "No problem, that has not shipped yet, so I can just change the quantity for " ++ label ++ ". <BR>Is that OK?",
  "displayText": "No problem, that has not shipped yet, so I can just change the quantity for " ++ label ++ ". <BR>Is that OK?"
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="93c9470c-44cb-44b8-b0ce-170bb6a261ba" message="#[payload]" />
	</sub-flow>
	<sub-flow name="listOrdersFlow" doc:id="ec6a625c-d90f-44d8-bca8-44e210259c50" >
		<http:request method="GET" doc:name="Request (OrderAPI)" doc:id="c39244f4-4f86-44f9-bb7f-b44537d8406d" config-ref="OrderAPI" url="https://mocksvc.mulesoft.com/mocks/449556cb-6c67-4cc2-bd92-18b335ac4e01/ordering/orders"/>
		<ee:transform doc:name="Set the payload and read the order list as an orderLabel" doc:id="e4d4b9aa-014c-4c62-80f5-f9f35d97d2d6">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-payload>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="ordersLabel"><![CDATA[%dw 2.0
output application/json
---
(payload.id map ($ ++ ", ")) reduce ($$ ++ $) as String
]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Appending the orderList size and orderLabel to the payload.displayText field" doc:id="2019d878-9ebf-4ce5-a057-01efdd4e7c39">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
  "data": {
			"type": "order-list",
			"text": "Sure, this are your last orders, which one you would like to look at?",
			"orders": [
				{
				"id": 3345001,
				"products": [
	  				{
					  "id": 7890001,
					  "price": {
					    "value": 47.95,
					    "currency": "USD"
					   },
  					   "name": "Eureka Cypress Sleeping Bag",
				       "image": {
				         "id": 8540001,
				         "url": "https://encrypted-tbn2.gstatic.com/shopping?q=tbn:ANd9GcSzTFAyV9Trgw3J3gmxL0unF0f1JTFmU1YBXsSnhB47xVbxxuBf3WzDerHeqM97Vfg0leKvu0i4&usqp=CAY"
				       }
				    }
				],
				"totalAmountPrice": 35,
				"totalAmountPriceCurrency": "USD",
				"shippingStatus": "shipped",
				"customerID": 5640099
			    },
			    {
			    "id": 3345002,
			    "products": [
	  				{
					  "id": 7890001,
					  "price": {
					    "value": 47.95,
					    "currency": "USD"
					   },
  					   "name": "Eureka Cypress Sleeping Bag",
				       "image": {
				         "id": 8540001,
				         "url": "https://encrypted-tbn2.gstatic.com/shopping?q=tbn:ANd9GcSzTFAyV9Trgw3J3gmxL0unF0f1JTFmU1YBXsSnhB47xVbxxuBf3WzDerHeqM97Vfg0leKvu0i4&usqp=CAY"
				       }
				    }
				],
			    "totalAmountPrice": 143.85,
			    "totalAmountPriceCurrency": "USD",
			    "shippingStatus": "non-shipped",
			    "customerID": 5640099
			  },
			  {
			    "id": 3345003,
			    "products": [
	  				{
					  "id": 7890001,
					  "price": {
					    "value": 47.95,
					    "currency": "USD"
					   },
  					   "name": "Eureka Cypress Sleeping Bag",
				       "image": {
				         "id": 8540001,
				         "url": "https://encrypted-tbn2.gstatic.com/shopping?q=tbn:ANd9GcSzTFAyV9Trgw3J3gmxL0unF0f1JTFmU1YBXsSnhB47xVbxxuBf3WzDerHeqM97Vfg0leKvu0i4&usqp=CAY"
				       }
				    }
				],
			    "totalAmountPrice": 9.99,
			    "totalAmountPriceCurrency": "USD",
			    "shippingStatus": "shipped",
			    "customerID": 5640099
			  }
			  ]
		   }   
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
	</sub-flow>
	<sub-flow name="showOrderDetails" doc:id="c4362728-860f-4cf1-bc26-14777a4c6d52" >
		<ee:transform doc:name="building URL and orderID vars" doc:id="c0b3d5bd-1e6b-476a-833e-3727154d11be" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="pathWithOrderID" ><![CDATA[%dw 2.0
output application/json
var orderID = payload.result.contexts[0].parameters.number as Number
---
("/ordering/orders/" ++ orderID) as String]]></ee:set-variable>
				<ee:set-variable variableName="orderID" ><![CDATA[%dw 2.0
output application/java
---
payload.result.contexts[0].parameters.number as Number]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<java:new doc:name="New fullProductList {as an ArrayList}" doc:id="d7419e5e-600f-448e-b511-cb9eeec8957e" target="fullProductList" class="java.util.ArrayList" constructor="ArrayList()" />
		<http:request method="GET" doc:name="Get Order (OrderAPI)" doc:id="c39244f4-4f86-44f9-bb7f-b44537d8406d" config-ref="OrderAPI" path='#[vars.pathWithOrderID]'/>
		<ee:transform doc:name="building the product Listn" doc:id="f5406c13-b298-4f5d-9cf3-547ef5b2ac2b" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload.products map ($)]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="orderDetails" ><![CDATA[%dw 2.0
output application/java
---
payload]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<foreach doc:name="For Each" doc:id="30081075-d897-4b98-ac55-788da89b1dc9" collection="#[payload]">
			<ee:transform doc:name="builder URL and product amount vars" doc:id="8f2ac492-287a-4969-a69b-a14dc92aa778" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
"/catalog/products/" ++ (payload.id as String)]]></ee:set-payload>
				</ee:message>
				<ee:variables >
					<ee:set-variable variableName="productAmount" ><![CDATA[%dw 2.0
output application/java
---
payload.amount as Number]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<http:request method="GET" doc:name="Get ProductData (CatalogAPI)" doc:id="2aa1108a-5a35-488f-96f7-a735546b2109" config-ref="Catalog_API" path="#[payload]" />
			<ee:transform doc:name="building a product with amount" doc:id="902501fe-d5bf-4899-a947-5927d8e3cded" >
				<ee:message >
					<ee:set-payload ><![CDATA[%dw 2.0
output application/java
---
{
	amount: vars.productAmount,
	product: {
		id: payload.id,
		price: payload.price,
		description: payload.description,
		copy: payload.copy,
		image: payload.image,
		company: payload.company,
		category: payload.category,
		object: {
	        "id": payload.id,
	        "price": payload.price,
	         "name": payload.copy,
	         "image": payload.image
        }       
	}
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
			<scripting:execute engine="groovy" doc:name="adding the product to productList" doc:id="f58f7986-8c9f-4934-a196-900e83c9b0bd" >
				<scripting:code >vars.fullProductList.add(payload)</scripting:code>
			</scripting:execute>
		</foreach>
		<ee:transform doc:name="Setting the payload whith the labels" doc:id="aa0cd380-bd87-41f7-a802-789726b48054" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
	"data": {
		"type": "order-detail",
		"text": "Thanks! Here is order " ++ vars.orderID ++ ". What do you want to change? ",
		"order": {
			id: vars.orderID,
			totalAmountPrice: vars.orderDetails.totalAmountPrice,
			totalAmountPriceCurrency: vars.orderDetails.totalAmountPriceCurrency,
			shippingStatus: vars.orderDetails.shippingStatus,
			customerID: vars.orderDetails.customerID,
			products: 
				vars.fullProductList.product.object map (
					$
				)
	   }
	}
}]]></ee:set-payload>
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="productsLabel" ><![CDATA[%dw 2.0
output application/json
---
{}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="a8a9e85e-62d9-48b2-9559-c9219f055f5b" message="#[payload]"/>
	</sub-flow>
</mule>
